local MarketplaceService = game:GetService("MarketplaceService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerMouse = Player:GetMouse()

local MyLibrary = {
    Themes = {        
        Main = {
       
        -- TEMA: Azul Violeta com Texto Branco
        ["Azul Violeta"] = {
            ["Color Hub 1"] = ColorSequence.new({
                ColorSequenceKeypoint.new(0.00, Color3.fromRGB(10, 10, 10)),    -- preto
                ColorSequenceKeypoint.new(0.50, Color3.fromRGB(75, 0, 130)),    -- azul violeta escuro
                ColorSequenceKeypoint.new(1.00, Color3.fromRGB(138, 43, 226))   -- violeta claro
            }),
            ["Color Hub 2"] = Color3.fromRGB(0, 0, 0),
            ["Color Stroke"] = Color3.fromRGB(138, 43, 226),     -- violeta claro
            ["Color Theme"] = Color3.fromRGB(20, 20, 20),        -- preto suave
            ["Color Text"] = Color3.fromRGB(255, 255, 255),      -- BRANCO
            ["Color Dark Text"] = Color3.fromRGB(200, 200, 200)  -- branco acinzentado
        },
    },
}

--[[
    Script: SourceOnce - Tracery [BETA] (Convertido para redzLib V4)
    Criado originalmente por: Artsynia & fxengif
    Adaptado para redzLib por: [Seu Nome]
    Nota: Funcionalidades que dependem de executors específicos (ex: getgenv, request, etc.) foram mantidas, mas podem precisar de ajustes.
]]

-- Carrega a redzLib
local redzLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/speedvip1/Main/refs/heads/main/redz%20lib%20V4.lua"))()

-- Serviços do jogo
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local VirtualUser = game:GetService("VirtualUser")
local TweenService = game:GetService("TweenService")

-- Variáveis do jogador local
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:FindFirstChildWhichIsA("Humanoid")
local RootPart = Character:FindFirstChild("HumanoidRootPart") or Character:FindFirstChild("Torso") or Character:FindFirstChild("UpperTorso")

-- Verificação do jogo (ID do jogo alvo)
local TARGET_GAME_ID = 893973440 -- Substitua pelo ID do jogo correto, se necessário
if game.PlaceId ~= TARGET_GAME_ID then
    -- Usa uma notificação simples, já que a da redzLib pode não estar pronta
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Jogo Incorreto",
        Text = "Este script não foi feito para este jogo.",
        Duration = 5
    })
    return
end

-- Tenta obter o nome do jogo
local productInfo = pcall(function() return MarketplaceService:GetProductInfo(game.PlaceId) end) and {Name = "Jogo Desconhecido"} or {Name = "Jogo Desconhecido"}
local GameName = productInfo.Name

-- Variáveis globais do script (para compartilhar entre funções)
_G.SHub = _G.SHub or {}
_G.SHub.Toggles = _G.SHub.Toggles or {}
_G.SHub.Values = _G.SHub.Values or {}
_G.SHub.Connections = _G.SHub.Connections or {}
_G.SHub.WPlr = _G.SHub.WPlr or {} -- Lista de players para ignorar no aura

-- Atualiza a referência do personagem quando ele morrer ou spawnar
local function updateCharacter()
    Character = LocalPlayer.Character
    if Character then
        Humanoid = Character:FindFirstChildWhichIsA("Humanoid")
        RootPart = Character:FindFirstChild("HumanoidRootPart") or Character:FindFirstChild("Torso") or Character:FindFirstChild("UpperTorso")
    end
end
_G.SHub.Connections.CharacterAdded = LocalPlayer.CharacterAdded:Connect(updateCharacter)
updateCharacter() -- Chama uma vez para configurar no início

-- Função para encontrar o RootPart ou Humanoid de um personagem
local function findRoot(character, returnHumanoid)
    if not character then return nil end
    local humanoid = character:FindFirstChildWhichIsA("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    if returnHumanoid then
        return humanoid
    else
        return rootPart
    end
end

-- Função para obter o container da UI (CoreGui ou PlayerGui)
local function getGuiParent()
    return CoreGui:FindFirstChild("RobloxGui") or CoreGui or PlayerGui
end

-- Função para arredondar números
local function round(num, numDecimalPlaces)
    local mult = 10^(numDecimalPlaces or 0)
    return math.floor(num * mult + 0.5) / mult
end

-- Obtém a lista de jogadores (exceto o local)
local function getPlayerList(returnNames)
    local list = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            table.insert(list, returnNames and p.Name or p)
        end
    end
    return list
end

-- --- CRIAÇÃO DA JANELA PRINCIPAL ---
local Window = redzLib:MakeWindow({
    Title = "SourceOnce • Tracery [BETA]",
    SubTitle = "by Artsynia & fxengif • Convertido",
    LoadText = "Carregando " .. GameName .. "...",
    DefaultTheme = "Default", -- Tema padrão
    Flags = "SourceOnce_Flags.lua" -- Arquivo para salvar flags
})

-- --- CRIAÇÃO DAS ABAS ---
local TabMain = Window:MakeTab({Name = "Main", Icon = "menu"})
local TabLocal = Window:MakeTab({Name = "Local", Icon = "user"})
local TabAnti = Window:MakeTab({Name = "Anti & Notify", Icon = "user-check"})
local TabGame = Window:MakeTab({Name = "Game & Ragebait", Icon = "server"})
local TabCredits = Window:MakeTab({Name = "Project & Credit", Icon = "heart"})
local TabSettings = Window:MakeTab({Name = "Settings", Icon = "settings"})

-- --- FUNÇÕES DE MAPA E ESP (Adaptadas) ---
local function GetCurrentMap()
    local map
    local currentMapVal = ReplicatedStorage:FindFirstChild("CurrentMap")
    if currentMapVal and currentMapVal:IsA("ObjectValue") and currentMapVal.Value and currentMapVal.Value:IsDescendantOf(Workspace) then
        map = currentMapVal.Value
    end
    if not map then
        for _, v in pairs(Workspace:GetChildren()) do
            if v:FindFirstChild("ComputerTable") or v:FindFirstChild("FreezePod") then
                map = v
                break
            end
        end
    end
    return map
end

-- Container para os ESPs
local espContainer = Instance.new("Folder")
espContainer.Name = "SourceOnce_ESP"
espContainer.Parent = getGuiParent()

-- Função para criar um BillboardGui
local function createBillboard(part, id, espParent, color)
    local billboard = espParent:FindFirstChild(id)
    if billboard then billboard:Destroy() end

    billboard = Instance.new("BillboardGui")
    billboard.Name = id
    billboard.Adornee = part
    billboard.Size = UDim2.new(5, 0, 5, 0)
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 0
    billboard.Parent = espParent

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.fromScale(1, 0.8)
    label.Position = UDim2.fromScale(0, 0.1)
    label.BackgroundTransparency = 1
    label.TextStrokeTransparency = 0.5
    label.TextSize = 13
    label.Font = Enum.Font.GothamSemibold
    label.TextColor3 = color or Color3.new(1, 1, 1)
    label.Text = "Carregando..."
    label.Parent = billboard

    local arrow = Instance.new("TextLabel")
    arrow.Name = "Arrow"
    arrow.Size = UDim2.new(1, 0, 0, 20)
    arrow.Position = UDim2.new(0.5, 0, 1, 0)
    arrow.AnchorPoint = Vector2.new(0.5, 0)
    arrow.BackgroundTransparency = 1
    arrow.TextColor3 = color or Color3.new(1, 1, 1)
    arrow.Font = Enum.Font.FredokaOne
    arrow.TextScaled = true
    arrow.Rotation = 180
    arrow.Text = "^"
    arrow.Parent = billboard

    return billboard, label, arrow
end

-- Função para criar/atualizar Highlight
local function applyHighlight(part, color)
    local hl = part:FindFirstChild("SourceOnce_Highlight")
    if not hl then
        hl = Instance.new("Highlight")
        hl.Name = "SourceOnce_Highlight"
        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        hl.FillTransparency = 0.5
        hl.OutlineTransparency = 0.85
        hl.Parent = part
    end
    hl.Adornee = part
    hl.FillColor = color or Color3.new(0, 0, 0)
    hl.OutlineColor = color or Color3.new(0, 0, 0)
    return hl
end

-- --- CONTEÚDO DAS ABAS ---

-- ABA MAIN
TabMain:AddSection({Name = "ESP"})

-- ESP Player
TabMain:AddToggle({
    Name = "ESP Player",
    Default = false,
    Flag = "EspPlayer",
    Callback = function(state)
        _G.SHub.Toggles.EspPlayer = state
        local espConnection = _G.SHub.Connections.EspPlayer

        if state then
            if espConnection then espConnection:Disconnect() end
            _G.SHub.Connections.EspPlayer = RunService.RenderStepped:Connect(function()
                if not _G.SHub.Toggles.EspPlayer then
                    _G.SHub.Connections.EspPlayer:Disconnect()
                    _G.SHub.Connections.EspPlayer = nil
                    -- Limpar ESP
                    for _, child in pairs(espContainer:GetChildren()) do
                        if child.Name:find("Player_") then child:Destroy() end
                    end
                    for _, p in pairs(Players:GetPlayers()) do
                        if p.Character then
                            local hl = p.Character:FindFirstChild("SourceOnce_Highlight")
                            if hl then hl:Destroy() end
                        end
                    end
                    return
                end

                for _, player in pairs(Players:GetPlayers()) do
                    if player == LocalPlayer then continue end
                    local char = player.Character
                    if not char then continue end

                    local head = char:FindFirstChild("Head")
                    local root = findRoot(char)
                    if not head or not root or not RootPart then continue end

                    -- Determinar cor baseado no estado (simplificado)
                    local color = Color3.fromRGB(200, 200, 200)
                    local stats = player:FindFirstChild("TempPlayerStatsModule")
                    if stats then
                        if stats:FindFirstChild("IsBeast") and stats.IsBeast.Value then
                            color = Color3.fromRGB(255, 0, 0)
                        elseif stats:FindFirstChild("Captured") and stats.Captured.Value then
                            color = Color3.fromRGB(0, 0, 255)
                        elseif stats:FindFirstChild("Health") and stats.Health.Value > 0 then
                            color = Color3.fromRGB(0, 255, 0)
                        end
                    end

                    local espId = "Player_" .. player.Name
                    local billboard = espContainer:FindFirstChild(espId)
                    if not billboard then
                        billboard, label = createBillboard(head, espId, espContainer, color)
                    else
                        billboard.Adornee = head
                        local label = billboard:FindFirstChild("Label")
                        if label then
                            local dist = round((root.Position - RootPart.Position).Magnitude, 1)
                            label.Text = string.format("%s • %d studs", player.Name, dist)
                            label.TextColor3 = color
                        end
                    end
                    applyHighlight(char, color)
                end
            end)
        else
            if espConnection then espConnection:Disconnect() end
        end
    end
})

-- ESP Computador
TabMain:AddToggle({
    Name = "ESP Computador",
    Default = false,
    Flag = "EspComputer",
    Callback = function(state)
        _G.SHub.Toggles.EspComputer = state
        local espConnection = _G.SHub.Connections.EspComputer

        if state then
            if espConnection then espConnection:Disconnect() end
            _G.SHub.Connections.EspComputer = RunService.RenderStepped:Connect(function()
                if not _G.SHub.Toggles.EspComputer then
                    _G.SHub.Connections.EspComputer:Disconnect()
                    _G.SHub.Connections.EspComputer = nil
                    for _, child in pairs(espContainer:GetChildren()) do
                        if child.Name:find("Computer_") then child:Destroy() end
                    end
                    return
                end

                local map = GetCurrentMap()
                if not map or not RootPart then return end

                for _, obj in pairs(map:GetChildren()) do
                    if obj.Name == "ComputerTable" then
                        local part = obj:FindFirstChildWhichIsA("BasePart")
                        if not part then continue end

                        local color = Color3.fromRGB(255, 255, 0)
                        local screen = obj:FindFirstChild("Screen")
                        if screen and screen:IsA("BasePart") then
                            color = screen.Color
                        end

                        local espId = "Computer_" .. obj:GetDebugId()
                        local billboard = espContainer:FindFirstChild(espId)
                        if not billboard then
                            billboard, label = createBillboard(obj, espId, espContainer, color)
                        else
                            billboard.Adornee = obj
                            local label = billboard:FindFirstChild("Label")
                            if label then
                                local dist = round((part.Position - RootPart.Position).Magnitude, 1)
                                label.Text = string.format("Computador • %d studs", dist)
                                label.TextColor3 = color
                            end
                        end
                        applyHighlight(obj, color)
                    end
                end
            end)
        else
            if espConnection then espConnection:Disconnect() end
        end
    end
})

-- ESP FreezePod
TabMain:AddToggle({
    Name = "ESP FreezePod",
    Default = false,
    Flag = "EspFreezePod",
    Callback = function(state)
        _G.SHub.Toggles.EspFreezePod = state
        local espConnection = _G.SHub.Connections.EspFreezePod

        if state then
            if espConnection then espConnection:Disconnect() end
            _G.SHub.Connections.EspFreezePod = RunService.RenderStepped:Connect(function()
                if not _G.SHub.Toggles.EspFreezePod then
                    _G.SHub.Connections.EspFreezePod:Disconnect()
                    _G.SHub.Connections.EspFreezePod = nil
                    for _, child in pairs(espContainer:GetChildren()) do
                        if child.Name:find("FreezePod_") then child:Destroy() end
                    end
                    return
                end

                local map = GetCurrentMap()
                if not map or not RootPart then return end

                for _, obj in pairs(map:GetChildren()) do
                    if obj.Name == "FreezePod" then
                        local part = obj:FindFirstChildWhichIsA("BasePart")
                        if not part then continue end

                        local color = Color3.fromRGB(0, 0, 245)

                        local espId = "FreezePod_" .. obj:GetDebugId()
                        local billboard = espContainer:FindFirstChild(espId)
                        if not billboard then
                            billboard, label = createBillboard(obj, espId, espContainer, color)
                        else
                            billboard.Adornee = obj
                            local label = billboard:FindFirstChild("Label")
                            if label then
                                local dist = round((part.Position - RootPart.Position).Magnitude, 1)
                                label.Text = string.format("FreezePod • %d studs", dist)
                                label.TextColor3 = color
                            end
                        end
                        applyHighlight(obj, color)
                    end
                end
            end)
        else
            if espConnection then espConnection:Disconnect() end
        end
    end
})

-- ABA LOCAL
TabLocal:AddSection({Name = "Jogador"})

-- Full Bright
TabLocal:AddToggle({
    Name = "Full Bright",
    Default = false,
    Flag = "FullBright",
    Callback = function(state)
        _G.SHub.Toggles.FullBright = state
        if state then
            _G.SHub.OriginalLighting = {
                Brightness = Lighting.Brightness,
                ClockTime = Lighting.ClockTime,
                FogEnd = Lighting.FogEnd,
                GlobalShadows = Lighting.GlobalShadows,
                Ambient = Lighting.Ambient,
                OutdoorAmbient = Lighting.OutdoorAmbient
            }
            local atm = Lighting:FindFirstChildOfClass("Atmosphere")
            if atm then _G.SHub.OriginalLighting.AtmosphereDensity = atm.Density end

            local function apply()
                Lighting.Brightness = 2
                Lighting.ClockTime = 14
                Lighting.FogEnd = 100000
                Lighting.GlobalShadows = false
                Lighting.Ambient = Color3.new(1, 1, 1)
                Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
                local atm = Lighting:FindFirstChildOfClass("Atmosphere")
                if atm then atm.Density = 0 end
            end

            _G.SHub.Connections.FullBright = RunService.RenderStepped:Connect(apply)
            apply()
        else
            if _G.SHub.Connections.FullBright then
                _G.SHub.Connections.FullBright:Disconnect()
                _G.SHub.Connections.FullBright = nil
            end
            if _G.SHub.OriginalLighting then
                for prop, val in pairs(_G.SHub.OriginalLighting) do
                    if prop == "AtmosphereDensity" then
                        local atm = Lighting:FindFirstChildOfClass("Atmosphere")
                        if atm then atm.Density = val end
                    else
                        Lighting[prop] = val
                    end
                end
            end
        end
    end
})

-- Infinito Jump
TabLocal:AddToggle({
    Name = "Infinito Jump",
    Default = false,
    Flag = "InfJump",
    Callback = function(state)
        _G.SHub.Toggles.InfJump = state
    end
})
UserInputService.JumpRequest:Connect(function()
    if _G.SHub.Toggles.InfJump and Humanoid then
        Humanoid:ChangeState("Jumping")
    end
end)

-- Noclip
TabLocal:AddToggle({
    Name = "Noclip",
    Default = false,
    Flag = "Noclip",
    Callback = function(state)
        _G.SHub.Toggles.Noclip = state
        local noclipConnection = _G.SHub.Connections.Noclip

        if state then
            if noclipConnection then noclipConnection:Disconnect() end
            _G.SHub.Connections.Noclip = RunService.Heartbeat:Connect(function()
                if not _G.SHub.Toggles.Noclip then
                    _G.SHub.Connections.Noclip:Disconnect()
                    _G.SHub.Connections.Noclip = nil
                    return
                end
                if Character then
                    for _, part in pairs(Character:GetDescendants()) do
                        if part:IsA("BasePart") and part.CanCollide then
                            part.CanCollide = false
                        end
                    end
                end
            end)
        else
            if noclipConnection then noclipConnection:Disconnect() end
        end
    end
})

-- Anti Ragdoll
TabLocal:AddToggle({
    Name = "Anti Ragdoll",
    Default = false,
    Flag = "AntiRagdoll",
    Callback = function(state)
        _G.SHub.Toggles.AntiRagdoll = state
        local antiRagConnection = _G.SHub.Connections.AntiRagdoll

        if state then
            if antiRagConnection then antiRagConnection:Disconnect() end
            _G.SHub.Connections.AntiRagdoll = RunService.Heartbeat:Connect(function()
                if not _G.SHub.Toggles.AntiRagdoll then
                    _G.SHub.Connections.AntiRagdoll:Disconnect()
                    _G.SHub.Connections.AntiRagdoll = nil
                    return
                end
                if Humanoid then
                    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics, false)
                    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
                end
                local stats = LocalPlayer:FindFirstChild("TempPlayerStatsModule")
                if stats then
                    local ragdoll = stats:FindFirstChild("Ragdoll")
                    if ragdoll and ragdoll:IsA("BoolValue") and ragdoll.Value then
                        repeat
                            task.wait()
                            if Humanoid then
                                Humanoid:ChangeState(Enum.HumanoidStateType.Running)
                            end
                        until not ragdoll.Value or not _G.SHub.Toggles.AntiRagdoll
                    end
                end
            end)
        else
            if antiRagConnection then antiRagConnection:Disconnect() end
        end
    end
})

-- ABA ANTI & NOTIFY
TabAnti:AddSection({Name = "Anti"})

-- Anti AFK
TabAnti:AddToggle({
    Name = "Anti AFK",
    Default = false,
    Flag = "AntiAfk",
    Callback = function(state)
        _G.SHub.Toggles.AntiAfk = state
        if state then
            if not _G.SHub.Connections.AntiAfk then
                _G.SHub.Connections.AntiAfk = LocalPlayer.Idled:Connect(function()
                    VirtualUser:CaptureController()
                    VirtualUser:ClickButton2(Vector2.zero)
                end)
            end
        else
            if _G.SHub.Connections.AntiAfk then
                _G.SHub.Connections.AntiAfk:Disconnect()
                _G.SHub.Connections.AntiAfk = nil
            end
        end
    end
})

-- ABA GAME & RAGEBAIT
TabGame:AddSection({Name = "Ragebait Beast"})

-- Função para encontrar eventos do Beast
local function getBeastEvent(eventType) -- eventType = "HammerEvent" or "PowersEvent"
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            if eventType == "HammerEvent" and p.Character:FindFirstChild("Hammer") then
                return p.Character:FindFirstChild(eventType, true)
            elseif eventType == "PowersEvent" and p.Character:FindFirstChild("BeastPowers") then
                return p.Character:FindFirstChild(eventType, true)
            end
        end
    end
end

-- Slow Beast
TabGame:AddToggle({
    Name = "Slow Beast (Jump Spam)",
    Default = false,
    Flag = "RgSlowBeast",
    Callback = function(state)
        _G.SHub.Toggles.RgSlowBeast = state
        local connection = _G.SHub.Connections.RgSlowBeast

        if state then
            if connection then connection:Disconnect() end
            _G.SHub.Connections.RgSlowBeast = RunService.Heartbeat:Connect(function()
                if not _G.SHub.Toggles.RgSlowBeast then
                    _G.SHub.Connections.RgSlowBeast:Disconnect()
                    _G.SHub.Connections.RgSlowBeast = nil
                    return
                end
                local powersEvent = getBeastEvent("PowersEvent")
                if powersEvent then
                    pcall(function() powersEvent:FireServer("Jumped") end)
                end
            end)
        else
            if connection then connection:Disconnect() end
        end
    end
})

-- Untie Player
TabGame:AddToggle({
    Name = "Beast Untie Player",
    Default = false,
    Flag = "RgUntie",
    Callback = function(state)
        _G.SHub.Toggles.RgUntie = state
        local connection = _G.SHub.Connections.RgUntie

        if state then
            if connection then connection:Disconnect() end
            _G.SHub.Connections.RgUntie = RunService.Heartbeat:Connect(function()
                if not _G.SHub.Toggles.RgUntie then
                    _G.SHub.Connections.RgUntie:Disconnect()
                    _G.SHub.Connections.RgUntie = nil
                    return
                end
                local hammerEvent = getBeastEvent("HammerEvent")
                if hammerEvent then
                    pcall(function() hammerEvent:FireServer("HammerClick", true) end)
                end
            end)
        else
            if connection then connection:Disconnect() end
        end
    end
})

-- ABA CREDITOS
TabCredits:AddParagraph({
    Name = "SourceOnce - Tracery",
    Text = "Versão Beta 1.1.0 (Convertido)\n\nCriadores originais: Artsynia, fxengif\nAdaptado para redzLib V4\n\nObrigado a todos que apoiaram! ❤️"
})

-- ABA CONFIGURAÇÕES (Usando os próprios elementos da redzLib)
-- A redzLib já tem opções de tema e configurações embutidas se usarmos o parâmetro Flags.
-- Podemos adicionar um botão para recarregar o tema, se quisermos.

-- Finalmente, seleciona a primeira aba
-- (Não há um método nativo na redzLib para selecionar, mas a primeira aba criada é a primeira visível)

print("Script carregado com sucesso!")
